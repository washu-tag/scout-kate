---
# Traefik Middleware for Content Security Policy (CSP)
# Prevents data exfiltration via external image URLs in LLM-generated content
# See: https://developer.nvidia.com/blog/practical-llm-security-advice-from-the-nvidia-ai-red-team/
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: open-webui-csp
  namespace: {{ chatbot_namespace }}
spec:
  headers:
    # Block external resources while allowing app functionality
    # - img-src: blocks external images (quickchart.io, etc.) that could exfiltrate data
    # - connect-src: allows WebSocket and Keycloak OAuth
    # - script/style: allows inline (required by Open WebUI frontend)
    contentSecurityPolicy: >-
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: blob:;
      font-src 'self' data:;
      connect-src 'self' ws: wss: {{ keycloak_base_url }} {{ oauth2_proxy_base_url }};
      frame-src 'self';
      form-action 'self' {{ keycloak_base_url }} {{ oauth2_proxy_base_url }};
      frame-ancestors 'none'
