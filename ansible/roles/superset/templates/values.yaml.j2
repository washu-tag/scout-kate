image:
  repository: "{{ superset_image_repository }}"
  tag: "{{ superset_image_tag }}"
redis:
  # Disable embedded Redis - using centralized Redis Enterprise instead
  enabled: false
extraSecretEnv:
  SUPERSET_SECRET_KEY: "{{ superset_secret }}"
ingress:
  enabled: true
  ingressClassName: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: >-
      kube-system-oauth2-proxy-error@kubernetescrd,
      kube-system-oauth2-proxy-auth@kubernetescrd,
      kube-system-security-headers@kubernetescrd
  path: /
  hosts:
    - "superset.{{ server_hostname }}"
postgresql:
  enabled: false
supersetNode:
  connections:
    db_host: "{{ db_host }}"
    db_port: "{{ db_port }}"
    db_user: "{{ superset_postgres_user }}"
    db_pass: "{{ superset_postgres_password }}"
    db_name: "{{ superset_database }}"
    redis_host: "{{ superset_redis_database_name }}.{{ redis_namespace }}"
    redis_port: "{{ superset_redis_database_port }}"
    redis_password: "{{ superset_redis_password }}"
    # Redis Enterprise doesn't support logical databases within an existing database and Superset doesn't support
    # multiple Redis databases
    # https://redis.io/kb/doc/2d6sxrbhhj/does-redis-enterprise-support-logical-databases-using-the-select-command
    redis_cache_db: "0"
    redis_celery_db: "0"
  resources: {{ superset_resources_default | combine(superset_resources | default({}), recursive=true) | to_json }}
  extraContainers:
    - name: statsd-exporter
      image: "{{ superset_statsd_exporter_image }}:{{ superset_statsd_exporter_tag }}"
      args:
        - --statsd.listen-udp=:{{ superset_statsd_port }}
        - --statsd.listen-tcp=
        - --web.listen-address=:{{ superset_statsd_metrics_port }}
        - --statsd.mapping-config=/etc/statsd-exporter/statsd_mapping.yaml
      ports:
        - name: statsd-udp
          containerPort: {{ superset_statsd_port }}
          protocol: UDP
        - name: metrics
          containerPort: {{ superset_statsd_metrics_port }}
          protocol: TCP
      resources: {{ superset_statsd_resources_default | combine(superset_statsd_resources | default({}), recursive=true) | to_json }}
      volumeMounts:
        - name: statsd-mapping
          mountPath: /etc/statsd-exporter
          readOnly: true
configOverrides:
  branding: |
    APP_NAME = "{{ superset_app_name }}"
    APP_ICON = "/static/assets/images/scout.png"
    APP_ICON_WIDTH = {{ superset_logo_width }}
    LOGO_TARGET_PATH = "https://{{ server_hostname }}"
    LOGO_TOOLTIP = "Scout Launchpad"
    FAVICONS = [{"href": "/static/assets/images/favicon.ico"}]
  custom_routing: |
    from flask import redirect, url_for
    from flask_appbuilder import expose, IndexView

    from superset.superset_typing import FlaskResponse

    class SupersetIndexView(IndexView):
        @expose("/")
        def index(self) -> FlaskResponse:
            return redirect(url_for("Superset.dashboard", dashboard_id_or_slug="scout"))

    FAB_INDEX_VIEW = f"{SupersetIndexView.__module__}.{SupersetIndexView.__name__}"
  sql_alchemy: |
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_size": {{ superset_pool_size }},
        "max_overflow": {{ superset_pool_max_overflow }},
        "pool_timeout": {{ superset_pool_timeout }},
    }
  enable_oauth: |
    from flask_appbuilder.security.manager import AUTH_OAUTH
    from flask_appbuilder.security.views import AuthOAuthView, expose
    from superset.security import SupersetSecurityManager
    from flask import redirect, session
    import logging
    OAUTH_PROVIDERS = OPENID_PROVIDERS = [
        {
            "name": "keycloak",
            "icon": "fa-key",
            "token_key": "access_token",
            "remote_app": {
                "client_id": "{{ keycloak_superset_client_id }}",
                "client_secret": "{{ keycloak_superset_client_secret }}",
                "client_kwargs": {"scope": "openid microprofile-jwt"},
                "api_base_url": "{{ keycloak_realm_url }}/protocol/",
                "access_token_url": "{{ keycloak_oidc_token_url }}",
                "authorize_url": "{{ keycloak_oidc_auth_url }}",
                "jwks_uri": "{{ keycloak_oidc_certs_url }}",
                "request_token_url": None
            },
        }
    ]
    AUTH_ROLES_MAPPING = {
        "superset_admin": ["Admin"],
        "superset_alpha": ["Alpha"],
        "superset_gamma": ["Gamma"],
        "superset_sql_lab": ["sql_lab"]
    }
    AUTH_TYPE = AUTH_OAUTH
    AUTH_USER_REGISTRATION = True
    AUTH_USER_REGISTRATION_ROLE = 'Alpha'
    AUTH_ROLES_SYNC_AT_LOGIN = True
    class KeycloakOAuthView(AuthOAuthView):
        """
        Custom Auth View to handle Keycloak login and logout redirection
        """
        @expose("/login/")
        def login(self, provider="keycloak"):
            # Hacky workaround to remove stale 'Access is Denied' error messages from session.
            # When an unauthenticated user tries to access a protected page, Superset queues an 'Access is Denied' popup message.
            # With OAuth, the user is redirected to an external login page, so the error is not shown immediately.
            # After successful login, the old error message is displayed, which is confusing since the user now has access.
            flashes = session.get('_flashes', [])
            logging.debug(f"Flashes before cleanup: {flashes}")
            session['_flashes'] = [f for f in flashes if f != ('danger', 'Access is Denied')]
            logging.debug(f"Flashes after cleanup: {session.get('_flashes', [])}")
            return super().login(provider=provider)
        @expose('/logout/', methods=['GET', 'POST'])
        def logout(self):
            super().logout()
            return redirect('{{ oauth2_proxy_signout_url }}')
    class KeycloakSecurityManager(SupersetSecurityManager):
        """
        Create a new SecurityManager that uses the KeycloakOAuthView and Keycloak role mapping
        """
        def __init__(self, appbuilder):
            super(KeycloakSecurityManager, self).__init__(appbuilder)
            app = self.appbuilder.get_app
            app.config.setdefault("AUTH_ROLES_MAPPING", AUTH_ROLES_MAPPING)
            app.config.setdefault("AUTH_TYPE", AUTH_OAUTH)
            self.authoauthview = KeycloakOAuthView
    CUSTOM_SECURITY_MANAGER = KeycloakSecurityManager
  proxy_configuration: |
    PREFERRED_URL_SCHEME = "https"
    ENABLE_PROXY_FIX = True
  prometheus_metrics: |
{{ lookup('file', role_path + '/files/superset_metrics.py') | indent(4, first=True) }}
  statsd_logging: |
    from superset.stats_logger import StatsdStatsLogger
    STATS_LOGGER = StatsdStatsLogger(
        host='localhost',
        port={{ superset_statsd_port }},
        prefix='{{ superset_statsd_prefix }}'
    )
extraVolumes:
  - name: dashboard-config
    configMap:
      name: dashboard-config
      items: {{ superset_dashboard_items | default([]) | to_json }}
  - name: scout-logo
    configMap:
      name: scout-logo
      defaultMode: 0644
  - name: statsd-mapping
    configMap:
      name: superset-statsd-mapping
extraVolumeMounts:
  - name: dashboard-config
    mountPath: /app/dashboard-config
  - name: scout-logo
    mountPath: /app/superset/static/assets/images/scout.png
    subPath: scout.png
    readOnly: true
  - name: scout-logo
    mountPath: /app/superset/static/assets/images/favicon.ico
    subPath: favicon.ico
    readOnly: true
init:
  initscript: |
    {{ lookup('template', 'init_script.sh.j2') | indent(4) }}
