grafana.ini:
  auth:
    disable_login_form: true
  auth.generic_oauth:
    enabled: true
    name: Keycloak-OAuth
    allow_sign_up: true
    auto_login: true
    client_id: "{{ keycloak_grafana_client_id }}"
    client_secret: $__file{/etc/secrets/keycloak-grafana/client-secret}
    scopes: openid microprofile-jwt
    email_attribute_path: email
    login_attribute_path: preferred_username
    name_attribute_path: name
    auth_url: '{{ keycloak_oidc_auth_url }}'
    token_url: '{{ keycloak_oidc_token_url }}'
    api_url: '{{ keycloak_oidc_userinfo_url }}'
    role_attribute_path: contains(groups[*], 'grafana-admin') && 'Admin' || 'None'
    role_attribute_strict: true
    allow_assign_grafana_admin: true
    signout_redirect_url: '{{ oauth2_proxy_signout_url }}'
  security:
    disable_gravatar: true
  server:
    root_url: 'https://grafana.{{ server_hostname }}'
  metrics:
    enabled: true
  dashboards:
    default_home_dashboard_path: /tmp/dashboards/hl7-ingest-dashboard.json
{% if grafana_alert_contact_point == 'email' %}
  smtp:
    enabled: true
    host: "{{ grafana_smtp_host }}"
    user: $__file{/etc/secrets/smtp-grafana/user}
    password: $__file{/etc/secrets/smtp-grafana/password}
    from_address: "{{ grafana_smtp_from_address }}"
    from_name: "{{ grafana_smtp_from_name | default('Scout') }}"
    skip_verify: "{{ grafana_smtp_skip_verify | default(false) }}"
{% endif %}
  analytics:
    reporting_enabled: false
    check_for_updates: false
    check_for_plugin_updates: false
{% if air_gapped | default(false) %}
  plugins:
    public_key_retrieval_disabled: true
    preinstall_disabled: true
{% endif %}

env:
  GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION: true

extraSecretMounts:
  - name: keycloak-grafana-client-secret
    mountPath: /etc/secrets/keycloak-grafana
    secretName: keycloak-grafana-client-secret
    readOnly: true
    optional: false
    subPath: ""
{% if grafana_alert_contact_point == 'email' %}
  - name: smtp-grafana
    mountPath: /etc/secrets/smtp-grafana
    secretName: smtp-grafana
    readOnly: true
    optional: false
    subPath: ""
{% endif %}

{% if air_gapped | default(false) %}
# Air-gapped plugin installation via ORAS init container
extraInitContainers:
  - name: plugin-installer
    image: '{{ oras_image }}:v{{ oras_version }}'
    env:
      - name: HOME
        value: /tmp
      - name: REGISTRY_USERNAME
        valueFrom:
          secretKeyRef:
            name: grafana-plugin-registry-credentials
            key: username
      - name: REGISTRY_PASSWORD
        valueFrom:
          secretKeyRef:
            name: grafana-plugin-registry-credentials
            key: password
    volumeMounts:
      - name: plugins
        mountPath: /var/lib/grafana/plugins
      - name: plugin-config
        mountPath: /config
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo "Starting Grafana plugin installation from Harbor..."

        # Read configuration
        REGISTRY=$(cat /config/registry)
        PROJECT=$(cat /config/project)

        # Login to Harbor registry
        echo "Logging into Harbor registry..."
        oras login "${REGISTRY}" \
          --username "${REGISTRY_USERNAME}" \
          --password "${REGISTRY_PASSWORD}" \
          --insecure

        # Parse and install each plugin
        echo "Installing plugins..."
        PLUGINS=$(cat /config/plugins)
        echo "${PLUGINS}" | sed 's/\[//g' | sed 's/\]//g' | sed 's/}, *{/}\n{/g' | while read -r plugin_json; do
          # Extract id and version using simple string manipulation
          PLUGIN_ID=$(echo "${plugin_json}" | sed 's/.*"id": *"\([^"]*\)".*/\1/')
          PLUGIN_VERSION=$(echo "${plugin_json}" | sed 's/.*"version": *"\([^"]*\)".*/\1/')

          if [ -n "${PLUGIN_ID}" ] && [ -n "${PLUGIN_VERSION}" ]; then
            echo "Installing plugin: ${PLUGIN_ID} version ${PLUGIN_VERSION}"

            # Pull plugin from Harbor
            PLUGIN_DIR="/var/lib/grafana/plugins/${PLUGIN_ID}"
            mkdir -p "${PLUGIN_DIR}"
            cd /tmp

            oras pull "${REGISTRY}/${PROJECT}/${PLUGIN_ID}:${PLUGIN_VERSION}" \
              --insecure \
              --output /tmp

            # Extract plugin
            PLUGIN_ZIP=$(ls /tmp/*.zip 2>/dev/null | head -1)
            if [ -n "${PLUGIN_ZIP}" ]; then
              unzip -o "${PLUGIN_ZIP}" -d "${PLUGIN_DIR}"
              rm -f "${PLUGIN_ZIP}"
              echo "Successfully installed ${PLUGIN_ID}"
            else
              echo "WARNING: No ZIP file found for ${PLUGIN_ID}"
            fi
          fi
        done

        echo "Plugin installation complete!"
        ls -la /var/lib/grafana/plugins/

extraContainerVolumes:
  - name: plugins
    emptyDir: {}
  - name: plugin-config
    configMap:
      name: grafana-plugin-config

extraVolumeMounts:
  - name: plugins
    mountPath: /var/lib/grafana/plugins
{% endif %}

ingress:
  enabled: true
  ingressClassName: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.middlewares: >-
      kube-system-oauth2-proxy-error@kubernetescrd,
      kube-system-oauth2-proxy-auth@kubernetescrd,
      kube-system-security-headers@kubernetescrd
  hosts:
    - 'grafana.{{ server_hostname }}'

datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: prometheus_datasource_01
        url: 'http://prometheus-server.{{ prometheus_namespace }}.svc.cluster.local:9090'
        editable: false
        isDefault: true

      - name: Loki
        type: loki
        uid: loki_datasource_01
        url: 'http://loki-gateway.{{ loki_namespace }}.svc.cluster.local/'
        editable: false
        isDefault: false
        jsonData:
          httpHeaderName1: 'X-Scope-OrgID'
        secureJsonData:
          httpHeaderValue1: 'scout'

sidecar:
  alerts:
    enabled: true
    label: grafana_alert
    labelValue: '1'
    watchMethod: SLEEP
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: '1'
    watchMethod: SLEEP
    provider:
      folder: Scout
  datasources:
    enabled: true

persistence:
  enabled: true
{% if grafana_storage_class is defined and grafana_storage_class %}
  storageClassName: '{{ grafana_storage_class }}'
{% endif %}
  size: '{{ grafana_storage_size }}'

resources: {{ grafana_resources_default | combine(grafana_resources | default({}), recursive=true) | to_json }}

# The chart drops all capabilities from init-chown-data except CHOWN, but it
# also needs DAC_OVERRIDE to traverse directories Grafana creates with mode 2700.
# Without DAC_OVERRIDE init-chown-data crashes on redeploy.
# See https://github.com/grafana/helm-charts/issues/752
initChownData:
  securityContext:
    capabilities:
      add:
        - CHOWN
        - DAC_OVERRIDE
      drop:
        - ALL

livenessProbe:
  initialDelaySeconds: 180
