---
# CoreDNS Customization
# Manages the coredns-custom ConfigMap in kube-system namespace
# to override CoreDNS behavior (deny-all in air-gapped mode,
# selective domain forwarding, arbitrary server blocks)
#
# Uses force replacement (not strategic merge or server-side apply)
# to ensure the ConfigMap exactly matches the rendered template.
# Strategic merge patch won't remove stale keys when variables are
# removed from inventory, and server-side apply has field ownership
# issues when transitioning from other apply methods.

- name: Determine if CoreDNS customization is needed
  ansible.builtin.set_fact:
    _coredns_custom_needed: >-
      {{
        (air_gapped | default(false) | bool) or
        (coredns_forward_domains | default([]) | length > 0) or
        (coredns_extra_server_blocks | default({}) | length > 0)
      }}

- name: Get current coredns-custom ConfigMap
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: coredns-custom
    namespace: kube-system
  register: _coredns_current_configmap

- name: Apply CoreDNS custom ConfigMap
  when: _coredns_custom_needed | bool
  block:
    - name: Render CoreDNS custom ConfigMap data
      ansible.builtin.set_fact:
        _coredns_custom_data: >-
          {{ lookup('template', 'coredns-custom-data.yaml.j2') | from_yaml }}

    - name: Check if CoreDNS ConfigMap needs updating
      ansible.builtin.set_fact:
        _coredns_configmap_changed: >-
          {{ (_coredns_current_configmap.resources | length == 0) or
             (_coredns_current_configmap.resources[0].data | default({}) != _coredns_custom_data) }}

    - name: Replace coredns-custom ConfigMap
      when: _coredns_configmap_changed | bool
      kubernetes.core.k8s:
        state: present
        force: true
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: coredns-custom
            namespace: kube-system
          data: '{{ _coredns_custom_data }}'

    - name: Restart CoreDNS to pick up custom configuration
      when: _coredns_configmap_changed | bool
      block:
        - name: Rollout restart CoreDNS deployment
          ansible.builtin.command:
            cmd: kubectl rollout restart deployment/coredns -n kube-system
          changed_when: true

        - name: Wait for CoreDNS rollout to complete
          ansible.builtin.command:
            cmd: kubectl rollout status deployment/coredns -n kube-system --timeout=120s
          changed_when: false

- name: Remove CoreDNS custom ConfigMap when not needed
  when: not (_coredns_custom_needed | bool) and
    (_coredns_current_configmap.resources | length > 0)
  block:
    - name: Delete coredns-custom ConfigMap
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: coredns-custom
        namespace: kube-system

    - name: Restart CoreDNS after removing custom configuration
      block:
        - name: Rollout restart CoreDNS deployment
          ansible.builtin.command:
            cmd: kubectl rollout restart deployment/coredns -n kube-system
          changed_when: true

        - name: Wait for CoreDNS rollout to complete
          ansible.builtin.command:
            cmd: kubectl rollout status deployment/coredns -n kube-system --timeout=120s
          changed_when: false
