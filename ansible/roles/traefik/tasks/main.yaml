---
# Main tasks for traefik role
# Configures Traefik ingress controller with TLS termination

- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - tls_cert_path is defined
      - tls_key_path is defined
    fail_msg: 'Required variables tls_cert_path and tls_key_path must be defined in inventory'

- name: Read TLS cert from remote
  no_log: true
  ansible.builtin.slurp:
    src: '{{ tls_cert_path }}'
  register: cert_file

- name: Read TLS key from remote
  no_log: true
  ansible.builtin.slurp:
    src: '{{ tls_key_path }}'
  register: key_file

- name: Create TLS secret
  no_log: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: '{{ traefik_tls_secret_name }}'
        namespace: '{{ traefik_namespace }}'
      type: kubernetes.io/tls
      data:
        tls.crt: '{{ cert_file.content }}'
        tls.key: '{{ key_file.content }}'

- name: Wait for helm-install-traefik job to complete
  ansible.builtin.command: kubectl -n {{ traefik_namespace }} wait --for=condition=complete --timeout={{ traefik_helm_job_timeout }}s job/helm-install-traefik
  register: traefik_install
  changed_when: false

- name: Wait for helm-install-traefik-crd job to complete
  ansible.builtin.command: kubectl -n {{ traefik_namespace }} wait --for=condition=complete --timeout={{ traefik_helm_job_timeout }}s job/helm-install-traefik-crd
  register: traefik_crd_install
  changed_when: false

- name: Apply Traefik TLSStore configuration
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: TLSStore
      metadata:
        name: default
        namespace: '{{ traefik_namespace }}'
      spec:
        defaultCertificate:
          secretName: '{{ traefik_tls_secret_name }}'

- name: Apply Traefik configuration to enforce TLS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: '{{ traefik_namespace }}'
      spec:
        valuesContent: |-
          ports:
            websecure:
              tls:
                enabled: true
            web:
              redirections:
                entryPoint:
                  to: websecure
                  scheme: https
                  permanent: true

- name: Apply global security headers middleware
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: security-headers
        namespace: '{{ traefik_namespace }}'
      spec:
        headers:
          stsSeconds: 31536000
          stsIncludeSubdomains: true
          frameDeny: true
          contentTypeNosniff: true
          contentSecurityPolicy: >-
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval';
            style-src 'self' 'unsafe-inline';
            img-src 'self' data: blob:;
            font-src 'self' data:;
            connect-src 'self' ws: wss: {{ keycloak_base_url }} {{ oauth2_proxy_base_url }};
            form-action 'self' {{ keycloak_base_url }} {{ oauth2_proxy_base_url }};
            frame-ancestors 'none'
          customResponseHeaders:
            Permissions-Policy: 'camera=(), microphone=(), geolocation=(), payment=()'
            Cross-Origin-Opener-Policy: 'same-origin'
            X-Powered-By: ''
            Server: ''

- name: Create redirect-to-launchpad Middleware
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: redirect-to-launchpad
        namespace: '{{ traefik_namespace }}'
      spec:
        redirectRegex:
          regex: '^https?://[^/]+(.*)'
          replacement: 'https://{{ server_hostname }}/'
          permanent: false

- name: Create catch-all Ingress for unknown subdomains
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: catch-all-redirect
        namespace: '{{ traefik_namespace }}'
        annotations:
          traefik.ingress.kubernetes.io/router.priority: '1'
          traefik.ingress.kubernetes.io/router.middlewares: >-
            {{ traefik_namespace }}-oauth2-proxy-error@kubernetescrd,
            {{ traefik_namespace }}-oauth2-proxy-auth@kubernetescrd,
            {{ traefik_namespace }}-redirect-to-launchpad@kubernetescrd,
            {{ traefik_namespace }}-security-headers@kubernetescrd
      spec:
        ingressClassName: traefik
        rules:
          - host: '*.{{ server_hostname }}'
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: traefik
                      port:
                        number: 80
