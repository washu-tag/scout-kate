name: Post-Commit Tasks

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main
      - 'ci-**'
      - 'demo**'

env:
  JAVA_DIST: 'zulu'
  JAVA_VERSION: '21'
  REGISTRY: ghcr.io

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      hl7log-extractor: ${{ steps.filter.outputs.hl7log-extractor }}
      hl7-transformer: ${{ steps.filter.outputs.hl7-transformer }}
      pyspark-notebook: ${{ steps.filter.outputs.pyspark-notebook }}
      embedding-notebook: ${{ steps.filter.outputs.embedding-notebook }}
      launchpad: ${{ steps.filter.outputs.launchpad }}
      superset: ${{ steps.filter.outputs.superset }}
      keycloak: ${{ steps.filter.outputs.keycloak }}
    steps:
      - uses: actions/checkout@v4.2.1
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            hl7log-extractor:
              - 'extractor/hl7log-extractor/**'
              - 'linting_java_checkstyle.xml'
            hl7-transformer:
              - 'extractor/hl7-transformer/**'
            pyspark-notebook:
              - 'helm/jupyter/notebook/**'
            embedding-notebook:
              - 'helm/jupyter/embedding-notebook/**'
            launchpad:
              - 'launchpad/**'
            superset:
              - 'helm/superset/**'
            keycloak:
              - 'keycloak/**'
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.2.1
      - uses: actions/setup-python@v5.2.0
        with:
          python-version: '3.12'
          cache: 'pip'
      - uses: actions/setup-java@v4
        with:
          distribution: ${{ ENV.JAVA_DIST }}
          java-version: ${{ ENV.JAVA_VERSION }}
          cache: 'gradle'
      - uses: pre-commit/action@v3.0.1
  build-and-upload-hl7log-extractor:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: extractor/hl7log-extractor
          image-name: hl7log-extractor
      - name: 'Build/Cache Image - hl7log-extractor'
        if: needs.changes.outputs.hl7log-extractor == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: extractor/hl7log-extractor
          image-name: hl7log-extractor
  build-and-upload-hl7-transformer:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: extractor/hl7-transformer
          image-name: hl7-transformer
      - name: 'Build/Cache Image - hl7-transformer'
        if: needs.changes.outputs.hl7-transformer == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: extractor/hl7-transformer
          image-name: hl7-transformer
  build-and-upload-pyspark-notebook:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: helm/jupyter/notebook
          image-name: pyspark-notebook
      - name: 'Build/Cache Image - pyspark-notebook'
        if: needs.changes.outputs.pyspark-notebook == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: helm/jupyter/notebook
          image-name: pyspark-notebook
  build-and-upload-embedding-notebook:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: helm/jupyter/embedding-notebook
          image-name: embedding-notebook
      - name: 'Build/Cache Image - embedding-notebook'
        if: needs.changes.outputs.embedding-notebook == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: helm/jupyter/embedding-notebook
          image-name: embedding-notebook
  build-and-upload-launchpad:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: launchpad
          image-name: launchpad
      - name: 'Build/Cache Image - launchpad'
        if: needs.changes.outputs.launchpad == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: launchpad
          image-name: launchpad
  build-and-upload-superset:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: helm/superset
          image-name: superset
      - name: 'Build/Cache Image - superset'
        if: needs.changes.outputs.superset == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: helm/superset
          image-name: superset
  build-and-upload-keycloak:
    runs-on: ubuntu-latest
    needs: changes
    permissions:
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Check if image exists'
        id: check-image
        uses: ./.github/actions/check-image-exists
        with:
          subproject: keycloak
          image-name: keycloak
      - name: 'Build/Cache Image - keycloak'
        if: needs.changes.outputs.keycloak == 'true' || steps.check-image.outputs.exists == 'false'
        uses: ./.github/actions/docker-build-cache
        with:
          subproject: keycloak
          image-name: keycloak
  unit-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.2.1
      - uses: actions/setup-java@v4
        with:
          distribution: ${{ ENV.JAVA_DIST }}
          java-version: ${{ ENV.JAVA_VERSION }}
          cache: 'gradle'
      - name: 'Unit tests: hl7log-extractor'
        shell: bash
        run: cd extractor/hl7log-extractor && ./gradlew test
  ansible-and-python-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.2.1
      - uses: actions/setup-python@v5.2.0
        with:
          python-version: '3.12'
      - name: Install Molecule and dependencies
        run: |
          pip install molecule ansible-core pytest pydantic
      - name: 'Unit tests: filter plugins'
        shell: bash
        run: cd ansible && pytest tests/unit/filter_plugins/ -v
      - name: 'Unit tests: Open WebUI link sanitizer filter'
        shell: bash
        run: cd ansible/roles/open-webui/files && pytest test_link_sanitizer_filter.py -v
      - name: 'Unit tests: verify-node'
        shell: bash
        run: cd verify-node && pytest tests/ -v
      - name: 'Molecule tests: postgres role'
        shell: bash
        run: cd ansible/roles/postgres && molecule test -s default
      - name: 'Molecule tests: scout_common role'
        shell: bash
        run: cd ansible/roles/scout_common && molecule test -s default
  deploy-and-test:
    runs-on: ubuntu-latest
    needs:
      - lint
      - build-and-upload-hl7log-extractor
      - build-and-upload-hl7-transformer
      - build-and-upload-pyspark-notebook
      - build-and-upload-embedding-notebook
      - build-and-upload-launchpad
      - build-and-upload-superset
      - build-and-upload-keycloak
      - unit-test
      - ansible-and-python-tests
    permissions:
      contents: read
      packages: read
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    steps:
      - uses: actions/checkout@v4.2.1
      - name: 'Free up disk space'
        shell: bash
        run: |
          echo "Disk space before cleanup:"
          df -h

          echo "Removing unnecessary tools to free up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/swift
          sudo rm -rf /opt/ghc
          sudo apt-get clean
          docker system prune -af --volumes

          echo "Disk space after cleanup:"
          df -h
      - name: 'Prepare inventory.yaml'
        shell: bash
        run: |
          sed -e "s/HOSTNAME/$(hostname)/" -e "s/K3S_TOKEN/$(openssl rand -hex 16)/" -e "s:WORK_DIR:$(pwd):" \
            .github/ci_resources/inventory.yaml > ansible/inventory.yaml
      - name: 'ansible-galaxy dependencies'
        shell: bash
        run: cd ansible && sudo -E /opt/pipx_bin/ansible-galaxy install -r collections/requirements.yaml
      - name: Install Python dependencies for Ansible Kubernetes modules
        run: |
          /opt/pipx/venvs/ansible-core/bin/python -m pip install kubernetes
      - name: 'Install k3s'
        shell: bash
        run: |
          cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/k3s.yaml
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ ENV.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 'Push image to k3s - hl7log-extractor'
        uses: ./.github/actions/k3s-image-import-or-pull
        with:
          subproject: extractor/hl7log-extractor
          image-name: hl7log-extractor
      - name: 'Push image to k3s - hl7-transformer'
        uses: ./.github/actions/k3s-image-import-or-pull
        with:
          subproject: extractor/hl7-transformer
          image-name: hl7-transformer
      - name: 'Install helm and helm diff'
        shell: bash
        run: cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/helm.yaml
      - name: 'Install postgres'
        shell: bash
        run: |
          cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/postgres.yaml
      - name: 'Install lake'
        shell: bash
        run: |
          cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -v -i inventory.yaml --diff playbooks/lake.yaml
          sudo -E kubectl describe pod -l v1.min.io/tenant=minio-scout -n scout-data
      - name: 'Install orchestrator'
        shell: bash
        run: |
          cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -i inventory.yaml --diff playbooks/orchestrator.yaml
      - name: 'Install extractor'
        shell: bash
        run: |
          cd ansible && sudo -E /opt/pipx_bin/ansible-playbook -i inventory.yaml --diff playbooks/extractor.yaml
      - name: 'Run tests'
        shell: bash
        run: |
          cp .github/ci_resources/test_config_template.json tests/ingest/src/test/resources/config/local.json
          sed -i "s:WORK_DIR:$(pwd):" .github/ci_resources/tests-job.yaml
          sudo -E kubectl apply -f .github/ci_resources/tests-job.yaml
          sudo -E kubectl wait --for=condition=complete --timeout=600s job/ci-tests -n scout-extractor &
          completion_pid=$!
          sudo -E kubectl wait --for=condition=failed --timeout=600s job/ci-tests -n scout-extractor && exit 1 &
          failure_pid=$!
          wait -n $completion_pid $failure_pid
      - name: Test Logs
        shell: bash
        if: always()
        run: |
          sudo -E kubectl -n scout-extractor logs job/ci-tests
      - name: Test Summary
        uses: test-summary/action@v2.4
        if: always()
        with:
          paths: 'tests/ingest/**/TEST-*.xml'
          show: 'fail, skip'
      - name: Logging (hl7log-extractor)
        shell: bash
        if: always()
        run: |
          sudo -E kubectl -n scout-extractor logs deployment/hl7log-extractor
      - name: Logging (hl7-transformer)
        shell: bash
        if: always()
        run: |
          sudo -E kubectl -n scout-extractor logs deployment/hl7-transformer
  publish:
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    needs: [changes, deploy-and-test]
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@v4.2.1
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ ENV.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Free up disk space
        shell: bash
        run: |
          echo "Disk space before cleanup:"
          df -h

          echo "Removing unnecessary tools to free up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/swift
          sudo rm -rf /opt/ghc
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          docker system prune -af --volumes

          echo "Disk space after cleanup:"
          df -h
      - name: 'Push Image - hl7log-extractor'
        if: needs.changes.outputs.hl7log-extractor == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: hl7log-extractor
      - name: 'Push Image - hl7-transformer'
        if: needs.changes.outputs.hl7-transformer == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: hl7-transformer
      - name: 'Push Image - pyspark-notebook'
        if: needs.changes.outputs.pyspark-notebook == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: pyspark-notebook
      - name: 'Push Image - embedding-notebook'
        if: needs.changes.outputs.embedding-notebook == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: embedding-notebook
      - name: 'Push Image - launchpad'
        if: needs.changes.outputs.launchpad == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: launchpad
      - name: 'Push Image - superset'
        if: needs.changes.outputs.superset == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: superset
      - name: 'Push Image - keycloak'
        if: needs.changes.outputs.keycloak == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: keycloak
  publish-demo:
    if: startsWith(github.ref_name, 'demo')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    needs: [changes, deploy-and-test]
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@v4.2.1
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ ENV.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Free up disk space
        shell: bash
        run: |
          echo "Disk space before cleanup:"
          df -h

          echo "Removing unnecessary tools to free up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/swift
          sudo rm -rf /opt/ghc
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          docker system prune -af --volumes

          echo "Disk space after cleanup:"
          df -h
      - name: 'Push Image - pyspark-notebook'
        if: needs.changes.outputs.pyspark-notebook == 'true'
        uses: ./.github/actions/docker-push
        with:
          image-name: pyspark-notebook
