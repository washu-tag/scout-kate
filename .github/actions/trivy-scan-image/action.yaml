name: 'Trivy Image Scan'
description: 'Scans a Docker image tarball for vulnerabilities'
inputs:
  image-name:
    description: 'Name of the image artifact'
    required: true
  severity:
    description: 'Severities to report and gate on'
    required: false
    default: 'CRITICAL,HIGH'
runs:
  using: 'composite'
  steps:
    - name: Download image artifact
      id: download
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: ${{ inputs.image-name }}
        path: ${{ runner.temp }}

    - name: Skip notice
      if: steps.download.outcome == 'failure'
      shell: bash
      env:
        IMAGE_NAME: ${{ inputs.image-name }}
      run: echo "No artifact found for ${IMAGE_NAME} — image was not rebuilt. Skipping scan."

    - name: Run Trivy (JSON — single scan)
      if: steps.download.outcome == 'success'
      uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.34.1
      with:
        input: '${{ runner.temp }}/${{ inputs.image-name }}.tar'
        scan-type: 'image'
        format: 'json'
        output: 'trivy-${{ inputs.image-name }}.json'
        severity: '${{ inputs.severity }}'
        exit-code: '0'

    - name: Convert JSON to SARIF
      if: steps.download.outcome == 'success'
      shell: bash
      env:
        IMAGE_NAME: ${{ inputs.image-name }}
      run: trivy convert --format sarif --output "trivy-${IMAGE_NAME}.sarif" "trivy-${IMAGE_NAME}.json"

    - name: Upload SARIF
      if: steps.download.outcome == 'success'
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-${{ inputs.image-name }}.sarif'
        category: 'trivy-${{ inputs.image-name }}'

    - name: Gate on fixable vulnerabilities
      if: steps.download.outcome == 'success'
      shell: bash
      env:
        IMAGE_NAME: ${{ inputs.image-name }}
        SEVERITY: ${{ inputs.severity }}
      run: |
        # Fail if any fixable vulnerability at the configured severity exists
        fixable=$(jq '[.Results[]?.Vulnerabilities[]? | select(.FixedVersion != null and .FixedVersion != "")] | length' "trivy-${IMAGE_NAME}.json")
        echo "Fixable vulnerabilities at ${SEVERITY}: $fixable"
        if [ "$fixable" -gt 0 ]; then
          echo "::error::Found $fixable fixable vulnerabilities. Run 'trivy image <image>' locally to see details."
          jq -r '.Results[]?.Vulnerabilities[]? | select(.FixedVersion != null and .FixedVersion != "") | "\(.Severity)\t\(.VulnerabilityID)\t\(.PkgName)\t\(.InstalledVersion) → \(.FixedVersion)"' "trivy-${IMAGE_NAME}.json" | sort
          exit 1
        fi
